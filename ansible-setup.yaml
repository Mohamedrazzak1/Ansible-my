#!/bin/bash

# Variables
USERNAME="ansible"
PASSWORD="Ansible@123"  # Change this to a secure password
SSH_CONFIG="/etc/ssh/sshd_config"
CLOUDIMG_CONFIG="/etc/ssh/sshd_config.d/60-cloudimg-settings.conf"

# Update package lists
echo "Updating packages..."
sudo apt update -y

# Install Ansible
echo "Installing Ansible..."
sudo apt install -y ansible

# Create the Ansible user
echo "Creating user '$USERNAME'..."
sudo useradd -m -s /bin/bash $USERNAME

# Set password for the user
echo "Setting password for '$USERNAME'..."
echo "$USERNAME:$PASSWORD" | sudo chpasswd

# Add user to sudo group
echo "Adding '$USERNAME' to sudo group..."
sudo usermod -aG sudo $USERNAME

# Enable password authentication for SSH
echo "Enabling password authentication..."
sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' $SSH_CONFIG
sudo sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' $SSH_CONFIG

# Update cloud-init SSH settings
echo "Updating $CLOUDIMG_CONFIG..."
sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' $CLOUDIMG_CONFIG
sudo sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' $CLOUDIMG_CONFIG

sudo systemctl restart sshd

echo "Setup completed successfully!"
